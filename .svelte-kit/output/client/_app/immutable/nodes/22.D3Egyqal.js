import{a as m,t as p,c as ye}from"../chunks/disclose-version.DTAQul2H.js";import{p as fe,b as n,g as e,a as me,d as b,c as r,s as l,r as t,t as q,n as ce,e as ge,F as xe,f as ne}from"../chunks/runtime.B4QXH2CN.js";import{i as E}from"../chunks/if.DRLG6bOh.js";import{t as be,f as he}from"../chunks/index.A-vRoXhT.js";import{p as ke,a as f}from"../chunks/preload-helper.B2IhT0O3.js";import{o as Re}from"../chunks/index-client.Bib29rnf.js";import{a as T}from"../chunks/Icon.yFnM2WBm.js";import{d as _e,a as S}from"../chunks/store.D_on7m4h.js";import{e as de,r as we,i as ve}from"../chunks/attributes.DPN48yOH.js";import{b as Se}from"../chunks/input.Br29pWBN.js";import{S as Ce}from"../chunks/search.K0UJueoa.js";import{b as ue}from"../chunks/select.CXmm0mL2.js";import{c as Me}from"../chunks/riskCalculator.D3oLOKg6.js";import{X as Ae}from"../chunks/x.xw5d-c1A.js";import{C as De}from"../chunks/chevron-left.WFET1Ekd.js";var Fe=p('<button disabled class="flex items-center gap-2 bg-success text-success-foreground px-3 py-1 rounded-lg opacity-50 cursor-not-allowed">Assessed</button>'),je=(L,i,u)=>i.onAssess(e(u)),Ne=p('<div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>'),Le=p('<button class="flex items-center gap-2 bg-primary text-primary-foreground px-3 py-1 rounded-lg hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"><!> Assess</button>'),Pe=p('<tr class="hover:bg-muted/50"><td class="px-4 py-3 font-medium"> </td><td class="px-4 py-3"> </td><td class="px-4 py-3"> </td><td class="px-4 py-3"> </td><td class="px-4 py-3"> </td><td class="px-4 py-3"> </td><td class="px-4 py-3"><div class="flex justify-center"><!></div></td></tr>'),ze=p('<div class="flex flex-col gap-4 p-4 container mx-auto"><div class="flex flex-col md:flex-row gap-4 mb-2 items-center justify-between"><div class="flex flex-col md:flex-row gap-4 flex-1"><div class="relative flex-1 w-full md:max-w-[300px]"><!> <input type="text" placeholder="Search risks..." class="pl-10 pr-4 py-2 bg-secondary rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-ring"></div></div></div> <div class="overflow-x-auto bg-card rounded-lg shadow border border-border"><table class="min-w-full table-auto"><thead class="bg-muted/50"><tr><th class="px-4 py-3 text-left">RRN</th><th class="px-4 py-3 text-left">Risk Statement</th><th class="px-4 py-3 text-left">Classification</th><th class="px-4 py-3 text-left">Actions</th><th class="px-4 py-3 text-left">Key Persons</th><th class="px-4 py-3 text-left">Budget</th><th class="px-4 py-3 text-center">Assessment</th></tr></thead><tbody class="divide-y divide-border"></tbody></table></div></div>');function Te(L,i){fe(i,!0);let u=b(""),d=ge(()=>i.savedRisks.filter(x=>x.rrn.toLowerCase().includes(e(u).toLowerCase())||x.risk_statement.toLowerCase().includes(e(u).toLowerCase()))),h=x=>new Set(i.riskAssessments.map(P=>P.risk_id)).has(x);var g=ze(),y=r(g),k=r(y),R=r(k),C=r(R);Ce(C,{class:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground",size:20});var A=l(C,2);we(A),t(R),t(k),t(y);var j=l(y,2),w=r(j),D=l(r(w));de(D,21,()=>e(d),x=>x.id,(x,v)=>{var P=Pe(),z=r(P),J=r(z,!0);t(z);var V=l(z),se=r(V,!0);t(V);var I=l(V),Q=r(I,!0);q(()=>{var N;return S(Q,((N=i.classification.find(M=>M.id===e(v).classification))==null?void 0:N.name)||"N/A")}),t(I);var B=l(I),H=r(B,!0);t(B);var W=l(B),ee=r(W,!0);t(W);var U=l(W),Y=r(U);t(U);var te=l(U),K=r(te),Z=r(K);E(Z,()=>e(v).id&&h(e(v).id),N=>{var M=Fe();m(N,M)},N=>{var M=Le();M.__click=[je,i,v];var O=r(M);E(O,()=>i.isSaving,X=>{var re=Ne();m(X,re)}),ce(),t(M),q(()=>M.disabled=i.isSaving),m(N,M)}),t(K),t(te),t(P),q(()=>{S(J,e(v).rrn),S(se,e(v).risk_statement),S(H,e(v).actions),S(ee,e(v).key_persons),S(Y,`P${e(v).budget??""}`)}),m(x,P)}),t(D),t(w),t(j),t(g),Se(A,()=>e(u),x=>n(u,x)),m(L,g),me()}_e(["click"]);const qe=async(L,i,u,d,h,g)=>{if(!(!e(i)||!u.selectedRisk||d()||e(h))){n(h,!0);try{const{data:y,error:k}=await T.from("risk_assessment").insert({risk_id:u.selectedRisk.id,lr:g.likelihoodRating,s:g.severity,rcr:g.riskControlRating,rmr:g.riskMonitoringRating}).select();if(k)throw k;u.onSuccess("Assessment saved successfully"),location.reload()}catch{u.onError("Failed to save assessment"),n(h,!1)}}};var Ee=p('<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50"><div class="animate-spin w-12 h-12 border-4 border-white border-t-transparent rounded-full"></div></div>'),Ie=p("<option> </option>"),Be=p("<option> </option>"),Ue=p('<div class="flex items-center gap-2"><span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-primary text-white font-semibold"> </span> <span class="text-gray-900 dark:text-gray-100"> </span></div>'),Ve=p('<p class="text-gray-500 dark:text-gray-400">Select likelihood and severity first</p>'),He=p("<option> </option>"),Ke=p('<div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>'),Oe=p('<div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"><div class="bg-card rounded-xl max-w-xl w-full shadow-xl"><div class="flex items-center justify-between p-6 border-b dark:border-gray-700"><div><h2 class="text-xl font-semibold text-gray-900 dark:text-white">Risk Assessment</h2> <p class="mt-1 text-sm text-gray-500 dark:text-gray-400"> </p></div> <button class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300 transition-colors"><!></button></div> <div class="p-6 space-y-6"><div class="bg-card border border-border p-4 rounded-lg"><h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Risk Statement</h3> <p class="mt-1 text-sm text-gray-900 dark:text-gray-100"> </p></div> <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-2"><label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Likelihood Rating</label> <select class="bg-secondary border-secondary rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-ring px-3 py-2"><option>Select likelihood</option><!></select></div> <div class="space-y-2"><label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Severity</label> <select class="bg-secondary border-secondary rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-ring px-3 py-2"><option>Select severity</option><!></select></div></div> <div class="space-y-2"><label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Risk Control Rating</label> <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg"><!></div></div> <div class="space-y-2"><label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Monitoring Rating</label> <select class="bg-secondary border-secondary rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-ring px-3 py-2"><option>Select monitoring rating</option><!></select></div></div> <div class="flex items-center justify-end gap-3 p-6 border-t dark:border-gray-700"><button class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Cancel</button> <button class="flex items-center gap-2 bg-primary text-primary-foreground px-4 py-2 rounded-lg hover:bg-primary/90 justify-center flex-1 md:flex-initial whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed"><!> Save Assessment</button></div></div></div>');function Xe(L,i){fe(i,!0);let u=ke(i,"isSaving",11,!1),d=f({likelihoodRating:null,severity:null,riskControlRating:null,riskMonitoringRating:null});const h=ge(()=>d.likelihoodRating!==null&&d.severity!==null&&d.riskControlRating!==null&&d.riskMonitoringRating!==null);let g=b(!1);xe(()=>{var R,C;if(d.likelihoodRating&&d.severity){const A=(R=i.likelihoodRating.find(w=>w.id===d.likelihoodRating))==null?void 0:R.symbol,j=(C=i.severity.find(w=>w.id===d.severity))==null?void 0:C.value;if(A&&j){const w=Me(A,j),D=i.riskControlRating.find(x=>x.symbol===w.controlRating);d.riskControlRating=(D==null?void 0:D.id)||null}}});var y=ye(),k=ne(y);E(k,()=>e(g),R=>{var C=Ee();m(R,C)},R=>{var C=Oe(),A=r(C),j=r(A),w=r(j),D=l(r(w),2),x=r(D);t(D),t(w);var v=l(w,2);v.__click=function(...o){var s;(s=i.onClose)==null||s.apply(this,o)};var P=r(v);Ae(P,{class:"h-5 w-5"}),t(v),t(j);var z=l(j,2),J=r(z),V=l(r(J),2),se=r(V,!0);t(V),t(J);var I=l(J,2),Q=r(I),B=l(r(Q),2),H=r(B);H.value=(H.__value=null)==null?"":null;var W=l(H);de(W,17,()=>i.likelihoodRating,ve,(o,s)=>{var _=Ie(),F={},$=r(_);t(_),q(()=>{F!==(F=e(s).id)&&(_.value=(_.__value=e(s).id)==null?"":e(s).id),S($,`${e(s).symbol??""} - ${e(s).name??""}`)}),m(o,_)}),t(B),t(Q);var ee=l(Q,2),U=l(r(ee),2),Y=r(U);Y.value=(Y.__value=null)==null?"":null;var te=l(Y);de(te,17,()=>i.severity,ve,(o,s)=>{var _=Be(),F={},$=r(_);t(_),q(()=>{F!==(F=e(s).id)&&(_.value=(_.__value=e(s).id)==null?"":e(s).id),S($,`${e(s).value??""} - ${e(s).name??""}`)}),m(o,_)}),t(U),t(ee),t(I);var K=l(I,2),Z=l(r(K),2),N=r(Z);E(N,()=>d.riskControlRating,o=>{var s=Ue();const _=ge(()=>i.riskControlRating.find(ae=>ae.id===d.riskControlRating));var F=r(s),$=r(F,!0);t(F);var G=l(F,2),le=r(G,!0);t(G),t(s),q(()=>{var ae,pe;S($,(ae=e(_))==null?void 0:ae.symbol),S(le,(pe=e(_))==null?void 0:pe.name)}),m(o,s)},o=>{var s=Ve();m(o,s)}),t(Z),t(K);var M=l(K,2),O=l(r(M),2),X=r(O);X.value=(X.__value=null)==null?"":null;var re=l(X);de(re,17,()=>i.riskMonitoringRating,ve,(o,s)=>{var _=ye(),F=ne(_);E(F,()=>e(s).status==="New Risk",$=>{var G=He(),le={},ae=r(G,!0);t(G),q(()=>{le!==(le=e(s).id)&&(G.value=(G.__value=e(s).id)==null?"":e(s).id),S(ae,e(s).status)}),m($,G)}),m(o,_)}),t(O),t(M),t(z);var ie=l(z,2),oe=r(ie);oe.__click=function(...o){var s;(s=i.onClose)==null||s.apply(this,o)};var a=l(oe,2);a.__click=[qe,h,i,u,g,d];var c=r(a);E(c,()=>u()||e(g),o=>{var s=Ke();m(o,s)}),ce(),t(a),t(ie),t(A),t(C),q(()=>{var o,s;S(x,`RRN: ${((o=i.selectedRisk)==null?void 0:o.rrn)??""}`),S(se,(s=i.selectedRisk)==null?void 0:s.risk_statement),oe.disabled=u()||e(g),a.disabled=!e(h)||u()||e(g)}),ue(B,()=>d.likelihoodRating,o=>d.likelihoodRating=o),ue(U,()=>d.severity,o=>d.severity=o),ue(O,()=>d.riskMonitoringRating,o=>d.riskMonitoringRating=o),m(R,C)}),m(L,y),me()}_e(["click"]);var Ge=p('<div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4 rounded"><p> </p></div>'),Je=p('<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded"><p> </p></div>'),Qe=p("<!> <!>",1);function We(L,i){var u=Qe(),d=ne(u);E(d,()=>i.successMessage,g=>{var y=Ge(),k=r(y),R=r(k,!0);t(k),t(y),q(()=>S(R,i.successMessage)),m(g,y)});var h=l(d,2);E(h,()=>i.errorMessage,g=>{var y=Je(),k=r(y),R=r(k,!0);t(k),t(y),q(()=>S(R,i.errorMessage)),m(g,y)}),m(L,u)}var Ye=p('<header><div class="container mx-auto px-4 py-6"><h1 class="text-3xl font-bold text-gray-900 dark:text-white"> </h1> <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">Manage and assess department risks</p></div></header>');function Ze(L,i){var u=Ye(),d=r(u),h=r(d),g=r(h);t(h),ce(2),t(d),t(u),q(()=>S(g,`${i.departmentName??""} Risk Register`)),m(L,u)}var $e=p('<div class="flex justify-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div>'),et=p("<!> <!>",1),tt=p('<a href="/risks" class="flex items-center gap-2 text-muted-foreground mb-2 hover:text-foreground"><!> Back</a> <div class="min-h-screen"><!> <main class="container mx-auto px-4 py-8"><!> <!></main></div>',1);function yt(L,i){fe(i,!0),f([]);let u=b(f([])),d=b(f([])),h=b(f([])),g=b(f([])),y=b(f([])),k=b(f([])),R=b(f([])),C=b(null),A=b(null),j=b(""),w=b(!0),D=b(!1),x=b(null),v=b(null),P=b(!1),z=b(null);const J=async()=>{try{await Promise.all([H(),W(),V(),se(),I(),Q(),B()])}catch{n(v,"Failed to fetch data. Please refresh the page.")}},V=async()=>{const{data:a,error:c}=await T.from("classification").select("*");if(c)throw c;n(h,f(a))},se=async()=>{try{const{data:a,error:c}=await T.from("likelihood_rating").select("*");if(c)throw c;n(g,f(a))}catch{n(v,"Failed to fetch likelihood rating.")}},I=async()=>{try{const{data:a,error:c}=await T.from("severity").select("*");if(c)throw c;n(y,f(a))}catch{n(v,"Failed to fetch severity.")}},Q=async()=>{try{const{data:a,error:c}=await T.from("risk_control_rating").select("*");if(c)throw c;n(k,f(a))}catch{n(v,"Failed to fetch risk control rating.")}},B=async()=>{try{const{data:a,error:c}=await T.from("risk_monitoring_rating").select("*");if(c)throw c;n(R,f(a))}catch{n(v,"Failed to fetch risk monitoring rating.")}},H=async()=>{var a;try{if(!((a=e(A))!=null&&a.department_id)){n(v,"Department ID not found. Please try reloading.");return}const{data:c,error:o}=await T.from("risks").select("*").eq("department_id",e(A).department_id).order("rrn",{ascending:!0});if(o)throw o;n(u,f(c))}catch{n(v,"Failed to fetch saved risks.")}},W=async()=>{try{const{data:a,error:c}=await T.from("risk_assessment").select("*");if(c)throw c;n(d,f(a))}catch{n(v,"Failed to fetch risk assessments.")}},ee=async()=>{n(w,!0);try{const{data:a}=await T.auth.getSession();if(n(C,f(a.session)),e(C)){const{data:c}=await T.from("profiles").select("id, department_id").eq("id",e(C).user.id).single();n(A,f(c));const{data:o}=await T.from("departments").select("name").eq("id",e(A).department_id).single();n(j,f(o?o.name:"Unknown Department")),await H(),await J()}}catch{n(v,"Failed to load profile. Please try again.")}finally{n(w,!1)}},U=a=>{n(z,f(a)),n(P,!0)},Y=()=>{n(P,!1),n(z,null)},te=a=>{n(x,f(a)),setTimeout(()=>n(x,null),3e3)},K=a=>{n(v,f(a)),setTimeout(()=>n(v,null),3e3)};Re(()=>{ee()});var Z=tt(),N=ne(Z),M=r(N);De(M,{size:20}),ce(),t(N);var O=l(N,2),X=r(O);Ze(X,{get departmentName(){return e(j)}});var re=l(X,2),ie=r(re);We(ie,{get successMessage(){return e(x)},get errorMessage(){return e(v)}});var oe=l(ie,2);E(oe,()=>e(w),a=>{var c=$e();be(3,c,()=>he),m(a,c)},a=>{var c=et(),o=ne(c);Te(o,{get savedRisks(){return e(u)},get classification(){return e(h)},get riskAssessments(){return e(d)},get isSaving(){return e(D)},onAssess:U});var s=l(o,2);E(s,()=>e(P),_=>{Xe(_,{get isSaving(){return e(D)},set isSaving(F){n(D,f(F))},get selectedRisk(){return e(z)},get likelihoodRating(){return e(g)},get severity(){return e(y)},get riskControlRating(){return e(k)},get riskMonitoringRating(){return e(R)},onClose:Y,onSuccess:te,onError:K})}),m(a,c)}),t(re),t(O),m(L,Z),me()}export{yt as component};
