import{c as Be,a as D,t as H}from"../chunks/disclose-version.DTAQul2H.js";import{f as ye,p as Ce,c as a,r as i,s as n,t as q,a as Fe,U as It,g as e,d as y,b as s,O as ct,n as Pe,e as Ne,m as $e}from"../chunks/runtime.B4QXH2CN.js";import{e as xe,a as B,d as tt}from"../chunks/store.D_on7m4h.js";import{i as pe}from"../chunks/if.DRLG6bOh.js";import{i as vt}from"../chunks/lifecycle.DAFDPKuL.js";import{o as pt}from"../chunks/index-client.Bib29rnf.js";import{I as _t,s as ft,a as h}from"../chunks/Icon.yFnM2WBm.js";import{a as et,e as be,i as Se,r as Ue,s as qt}from"../chunks/attributes.DPN48yOH.js";import{t as nt,f as lt}from"../chunks/index.A-vRoXhT.js";import{l as ut,s as mt,p as Ee,a as g}from"../chunks/preload-helper.B2IhT0O3.js";import{s as gt}from"../chunks/class.BN6JjLqI.js";import{b as ue}from"../chunks/input.Br29pWBN.js";import{b as je}from"../chunks/select.CXmm0mL2.js";import{T as ht}from"../chunks/trash-2.DnhmlcTU.js";import{T as xt}from"../chunks/triangle-alert.BSZOOXW1.js";import{P as Tt}from"../chunks/plus.BfN9yc11.js";import{E as Ut,a as jt}from"../chunks/jspdf.plugin.autotable.BvDXkAOZ.js";import{A as dt}from"../chunks/arrow-up-down.0onLll3z.js";import{S as Bt}from"../chunks/search.K0UJueoa.js";import{D as Vt}from"../chunks/download.CXU6lRmm.js";function Lt(M,r){const l=ut(r,["children","$$slots","$$events","$$legacy"]);_t(M,mt({name:"arrow-up-right"},()=>l,{iconNode:[["path",{d:"M7 7h10v10"}],["path",{d:"M7 17 17 7"}]],children:(_,b)=>{var m=Be(),k=ye(m);ft(k,r,"default",{}),D(_,m)},$$slots:{default:!0}}))}function Ot(M,r){const l=ut(r,["children","$$slots","$$events","$$legacy"]);_t(M,mt({name:"circle-plus"},()=>l,{iconNode:[["circle",{cx:"12",cy:"12",r:"10"}],["path",{d:"M8 12h8"}],["path",{d:"M12 8v8"}]],children:(_,b)=>{var m=Be(),k=ye(m);ft(k,r,"default",{}),D(_,m)},$$slots:{default:!0}}))}var Ht=H("<option> </option>"),Kt=H('<div class="bg-card rounded-lg p-4 border border-border hover:shadow-lg transition-shadow"><div class="space-y-4"><div class="flex justify-between items-start"><div><h3 class="text-lg font-medium truncate"> </h3></div> <div class="flex items-center gap-2"><a title="View Risk Assessment"><span class="text-sm">Risk Assessment</span> <!></a> <button class="p-2 hover:bg-red-100 text-red-500 hover:text-red-600 rounded-lg" title="Delete risk"><!></button></div></div> <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Risk Statement</label> <textarea placeholder="Enter risk statement..." class="w-full h-24 px-3 py-2 bg-card rounded-lg border border-border focus:outline-none focus:ring-2 focus:ring-primary/50"></textarea></div> <div><label class="block text-sm font-medium mb-1">Actions</label> <textarea placeholder="Enter actions..." class="w-full h-24 px-3 py-2 bg-card rounded-lg border border-border focus:outline-none focus:ring-2 focus:ring-primary/50"></textarea></div></div> <div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Classification</label> <select class="w-full px-3 py-2 bg-card rounded-lg border border-border focus:outline-none focus:ring-2 focus:ring-primary/50"><option>Select classification</option><!></select></div> <div><label class="block text-sm font-medium mb-1">Key Persons</label> <textarea placeholder="Enter key persons..." class="w-full h-24 px-3 py-2 bg-card rounded-lg border border-border focus:outline-none focus:ring-2 focus:ring-primary/50"></textarea></div> <div><label class="block text-sm font-medium mb-1">Budget</label> <input type="number" placeholder="Enter budget..." class="w-full px-3 py-2 bg-card rounded-lg border border-border focus:outline-none focus:ring-2 focus:ring-primary/50"></div></div></div></div></div>');function Yt(M,r){Ce(r,!1);let l=Ee(r,"risk",12),x=Ee(r,"classification",8),_=Ee(r,"index",8),b=Ee(r,"removeRow",8),m=Ee(r,"onUpdate",8);vt();var k=Kt(),z=a(k),v=a(z),A=a(v),T=a(A),K=a(T,!0);i(T),i(A);var V=n(A,2),U=a(V),L=n(a(U),2);Lt(L,{size:18}),i(U);var G=n(U,2),$=a(G);ht($,{size:18}),i(G),i(V),i(v);var Q=n(v,2),re=a(Q),N=a(re),J=n(a(N),2);et(J),i(N);var Y=n(N,2),O=n(a(Y),2);et(O),i(Y),i(re);var ie=n(re,2),ae=a(ie),W=n(a(ae),2);q(()=>{l().classification,It(()=>{m(),_(),x()})});var C=a(W);C.value=(C.__value=null)==null?"":null;var f=n(C);be(f,1,x,Se,(w,F)=>{var se=Ht(),ee={},_e=a(se,!0);i(se),q(()=>{ee!==(ee=e(F).id)&&(se.value=(se.__value=e(F).id)==null?"":e(F).id),B(_e,e(F).name)}),D(w,se)}),i(W),i(ae);var c=n(ae,2),u=n(a(c),2);et(u),i(c);var I=n(c,2),P=n(a(I),2);Ue(P),i(I),i(ie),i(Q),i(z),i(k),q(()=>{B(K,l().rrn),qt(U,"href",`/risks/riskAssessment?riskId=${l().id}`),gt(U,`inline-flex items-center gap-1 p-2 hover:bg-muted rounded-lg text-muted-foreground hover:text-foreground disabled:opacity-50 ${(l().id?"":"pointer-events-none opacity-50")??""}`)}),xe("click",G,()=>b()(_())),ue(J,()=>l().risk_statement,w=>l(l().risk_statement=w,!0)),xe("input",J,()=>m()(_())),ue(O,()=>l().actions,w=>l(l().actions=w,!0)),xe("input",O,()=>m()(_())),je(W,()=>l().classification,w=>l(l().classification=w,!0)),xe("change",W,()=>m()(_())),ue(u,()=>l().key_persons,w=>l(l().key_persons=w,!0)),xe("input",u,()=>m()(_())),ue(P,()=>l().budget,w=>l(l().budget=w,!0)),xe("input",P,()=>m()(_())),D(M,k),Fe()}const Qt=(M,r,l,x,_)=>{var m,k;const b=`RRN-${e(r)}-${String(e(l)).padStart(3,"0")}`;ct(l),s(x,g([...e(x),{rrn:b,risk_statement:"",classification:null,actions:"",key_persons:"",budget:0,profile_id:((m=e(_))==null?void 0:m.id)||"",department_id:((k=e(_))==null?void 0:k.department_id)||"",isNew:!0}]))},Wt=async(M,r,l,x,_,b)=>{var m;s(r,!0);try{const z=e(l).filter(v=>v.isNew||v.isEdited).map(({isNew:v,isEdited:A,id:T,...K})=>K);if(z.length>0){const{error:v}=await h.from("risks").upsert(z,{onConflict:"rrn"});if(v)throw v;const{data:A,error:T}=await h.from("risks").select("*").eq("profile_id",(m=e(x))==null?void 0:m.id);if(T)throw T;s(l,g(A||[])),s(_,"Risks saved successfully!")}else s(_,"No changes to save.");setTimeout(()=>{s(_,null)},3e3)}catch(k){console.error("Error saving risks:",k),s(b,"Failed to save risks."),setTimeout(()=>{s(b,null)},3e3)}finally{s(r,!1)}};var Gt=H('<div class="flex items-center p-4 rounded-lg bg-green-100 text-green-800"><span> </span></div>'),Jt=H('<div class="flex items-center p-4 rounded-lg bg-red-100 text-red-800"><span> </span></div>'),Xt=H('<div class="flex justify-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div>'),Zt=H('<div class="animate-spin inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full mr-2"></div>'),$t=H('<div class="grid grid-cols-1 gap-4 mb-6"></div> <div class="flex flex-wrap gap-4"><button class="inline-flex items-center px-4 py-2 bg-secondary text-secondary-foreground rounded-lg hover:bg-secondary/90 transition-colors"><!> Add Risk</button> <button class="inline-flex items-center px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors disabled:opacity-50"><!> Submit Risks</button></div>',1),er=H('<div class="flex flex-col gap-4 p-4 container mx-auto"><!> <!> <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><div class="flex items-center gap-2"><!> <h1 class="text-2xl font-bold"> </h1></div></div> <div class="bg-card rounded-lg shadow border border-border p-6"><!></div></div>');function tr(M,r){Ce(r,!0);let l=y(g([])),x=y(g([])),_=y(null),b=y(""),m=y(!0),k=y(!1),z=y(null),v=y(null),A=y(1);const T=async()=>{try{await K(),await U(),await L(),await V()}catch(f){console.error("Error fetching data:",f),s(v,"Failed to fetch data. Please try again.")}},K=async()=>{var f,c;try{const{data:u,error:I}=await h.auth.getSession();if(I)throw I;const P=(c=(f=u==null?void 0:u.session)==null?void 0:f.user)==null?void 0:c.id;if(!P)throw new Error("No logged-in user found.");const{data:w,error:F}=await h.from("profiles").select("id, department_id").eq("id",P).single();if(F)throw F;s(_,g(w));const{data:se,error:ee}=await h.from("departments").select("name").eq("id",e(_).department_id).single();if(ee)throw ee;s(b,g(se.name))}catch(u){console.error("Error fetching user profile:",u),s(v,"Failed to fetch profile details.")}},V=async()=>{try{const{data:f,error:c}=await h.from("classification").select("id, name");if(c)throw c;s(x,g(f||[]))}catch(f){console.error("Error fetching classifications:",f),s(v,"Failed to fetch classifications.")}},U=async()=>{var f;try{const{data:c,error:u}=await h.from("risks").select("*").eq("department_id",(f=e(_))==null?void 0:f.department_id).order("rrn",{ascending:!0});if(u)throw u;s(l,g(c||[]))}catch(c){console.error("Error fetching risks:",c),s(v,"Failed to fetch risks.")}},L=async()=>{var f;try{const{data:c,error:u}=await h.from("risks").select("rrn").eq("profile_id",(f=e(_))==null?void 0:f.id).order("rrn",{ascending:!1}).limit(1);if(u)throw u;if(c.length>0){const P=c[0].rrn.match(/(\d+)$/);s(A,g(P?parseInt(P[0],10)+1:1))}else s(A,1)}catch(c){console.error("Error fetching next RRN number:",c),s(v,"Failed to determine the next RRN number.")}},G=f=>{e(l)[f]&&(e(l)[f].isEdited=!0)},$=async f=>{const c=e(l)[f];if(c.isNew){s(l,g(e(l).filter((u,I)=>I!==f))),ct(A,-1);return}try{const{error:u}=await h.from("risks").delete().eq("rrn",c.rrn);if(u)throw u;s(l,g(e(l).filter((I,P)=>P!==f))),s(z,"Risk deleted successfully!")}catch(u){console.error("Error deleting risk:",u),s(v,"Failed to delete risk.")}finally{setTimeout(()=>{s(z,null),s(v,null)},3e3)}};pt(async()=>{s(m,!0),await T(),s(m,!1)});var Q=er(),re=a(Q);pe(re,()=>e(z),f=>{var c=Gt(),u=a(c),I=a(u,!0);i(u),i(c),q(()=>B(I,e(z))),nt(3,c,()=>lt),D(f,c)});var N=n(re,2);pe(N,()=>e(v),f=>{var c=Jt(),u=a(c),I=a(u,!0);i(u),i(c),q(()=>B(I,e(v))),nt(3,c,()=>lt),D(f,c)});var J=n(N,2),Y=a(J),O=a(Y);xt(O,{class:"w-8 h-8 text-primary"});var ie=n(O,2),ae=a(ie);i(ie),i(Y),i(J);var W=n(J,2),C=a(W);pe(C,()=>e(m),f=>{var c=Xt();D(f,c)},f=>{var c=$t(),u=ye(c);be(u,21,()=>e(l),Se,(ee,_e,Ve)=>{Yt(ee,{get risk(){return e(_e)},get classification(){return e(x)},index:Ve,removeRow:ke=>$(ke),onUpdate:ke=>G(ke)})}),i(u);var I=n(u,2),P=a(I);P.__click=[Qt,b,A,l,_];var w=a(P);Tt(w,{class:"w-4 h-4 mr-2"}),Pe(),i(P);var F=n(P,2);F.__click=[Wt,k,l,_,z,v];var se=a(F);pe(se,()=>e(k),ee=>{var _e=Zt();D(ee,_e)},ee=>{Ot(ee,{class:"w-4 h-4 mr-2"})}),Pe(),i(F),i(I),q(()=>F.disabled=e(k)),D(f,c)}),i(W),i(Q),q(()=>B(ae,`${e(b)??""} Risk Register`)),D(M,Q),Fe()}tt(["click"]);var rr=H('<div class="space-y-1"><div><span class="font-medium">Likelihood:</span> </div> <div><span class="font-medium">Severity:</span> </div> <div><span class="font-medium">Control Rating:</span> </div> <div><span class="font-medium">Monitoring Rating:</span> </div></div>'),ir=(M,r)=>r.onApprove(r.risk.id),ar=(M,r)=>r.onDelete(r.risk.id),sr=H('<tr class="hover:bg-muted/50"><td class="px-4 py-3"> </td><td class="px-4 py-3"> </td><td class="px-4 py-3"> </td><td class="px-4 py-3"> </td><td class="px-4 py-3"> </td><td class="px-4 py-3"> </td><td class="px-4 py-3"></td><td class="px-4 py-3"><div class="flex items-center gap-2"><button class="px-2 py-1 rounded bg-green-500 text-white hover:bg-green-600 disabled:opacity-50 text-sm"> </button> <button class="p-1 rounded hover:bg-muted text-red-500 hover:text-red-600 disabled:opacity-50"><!></button></div></td></tr>');function or(M,r){Ce(r,!0);var l=sr(),x=a(l),_=a(x,!0);i(x);var b=n(x),m=a(b,!0);i(b);var k=n(b),z=a(k,!0);q(()=>{var Y;return B(z,((Y=r.classification.find(O=>O.id===r.risk.classification))==null?void 0:Y.name)||"N/A")}),i(k);var v=n(k),A=a(v,!0);i(v);var T=n(v),K=a(T,!0);i(T);var V=n(T),U=a(V);q(()=>B(U,`P${r.risk.budget.toFixed(2)??""}`)),i(V);var L=n(V);be(L,21,()=>r.riskAssessments.filter(Y=>Y.risk_id===r.risk.id),Se,(Y,O)=>{var ie=rr(),ae=a(ie),W=n(a(ae));q(()=>{var w;return B(W,` ${(((w=r.likelihoodRatings.find(F=>F.id===e(O).lr))==null?void 0:w.name)||"N/A")??""}`)}),i(ae);var C=n(ae,2),f=n(a(C));q(()=>{var w;return B(f,` ${(((w=r.severities.find(F=>F.id===e(O).s))==null?void 0:w.value)||"N/A")??""}`)}),i(C);var c=n(C,2),u=n(a(c));q(()=>{var w;return B(u,` ${(((w=r.riskControlRatings.find(F=>F.id===e(O).rcr))==null?void 0:w.name)||"N/A")??""}`)}),i(c);var I=n(c,2),P=n(a(I));q(()=>{var w;return B(P,` ${(((w=r.riskMonitoringRatings.find(F=>F.id===e(O).rmr))==null?void 0:w.status)||"N/A")??""}`)}),i(I),i(ie),D(Y,ie)}),i(L);var G=n(L),$=a(G),Q=a($);Q.__click=[ir,r];var re=a(Q,!0);i(Q);var N=n(Q,2);N.__click=[ar,r];var J=a(N);ht(J,{size:16}),i(N),i($),i(G),i(l),q(()=>{B(_,r.risk.rrn),B(m,r.risk.risk_statement),B(A,r.risk.actions),B(K,r.risk.key_persons),Q.disabled=r.approvingId===r.risk.id||r.userRole==="admin"&&r.risk.is_approved||r.userRole==="vice_president"&&(!r.risk.is_approved||r.risk.is_approved_vp)||r.userRole==="president"&&(!r.risk.is_approved_vp||r.risk.is_approved_president),B(re,r.approvingId===r.risk.id?"Processing...":r.userRole==="admin"?r.risk.is_approved?"Admin Approved":"Approve":r.userRole==="vice_president"?r.risk.is_approved_vp?"VP Approved":"Approve":r.userRole==="president"&&r.risk.is_approved_president?"President Approved":"Approve"),N.disabled=r.deletingId===r.risk.id}),D(M,l),Fe()}tt(["click"]);var nr=(M,r)=>s(r,!e(r)),lr=H("<option> </option>"),dr=H("<option> </option>"),cr=H('<div class="flex justify-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div>'),vr=(M,r)=>r("rrn"),pr=(M,r)=>s(r,e(r)-1),_r=(M,r)=>s(r,e(r)+1),fr=H('<div class="overflow-x-auto bg-card rounded-lg shadow border border-border"><table class="min-w-full table-auto"><thead class="bg-muted/50"><tr><th class="px-4 py-3 text-left"><button class="flex items-center gap-1 hover:text-primary">RRN <!></button></th><th class="px-4 py-3 text-left">Risk Statement</th><th class="px-4 py-3 text-left">Classification</th><th class="px-4 py-3 text-left">Actions</th><th class="px-4 py-3 text-left">Key Persons</th><th class="px-4 py-3 text-left">Budget</th><th class="px-4 py-3 text-left">Risk Assessments</th><th class="px-4 py-3 text-left w-[150px]">Actions</th></tr></thead><tbody class="divide-y divide-border"></tbody></table></div> <div class="flex flex-col sm:flex-row justify-between items-center gap-4"><div class="text-sm text-muted-foreground"> </div> <div class="flex flex-col sm:flex-row items-center gap-4"><select class="bg-secondary rounded-lg px-2 py-1 w-full sm:w-auto"><option>5 per page</option><option>10 per page</option><option>25 per page</option><option>50 per page</option></select> <div class="flex gap-2"><button class="px-3 py-1 rounded-lg border border-border hover:bg-muted disabled:opacity-50">Previous</button> <button class="px-3 py-1 rounded-lg border border-border hover:bg-muted disabled:opacity-50">Next</button></div></div></div>',1),ur=H('<div class="flex flex-col gap-4 container mx-auto p-6"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><div class="flex items-center gap-2"><!> <h1 class="text-2xl font-bold">Risk Management</h1></div></div> <button class="md:hidden w-full px-4 py-2 bg-secondary rounded-lg text-left flex justify-between items-center">Filters <!></button> <div><div class="flex flex-col md:flex-row gap-4 w-full md:w-auto flex-1"><div class="relative flex-2 md:w-[300px]"><!> <input type="text" placeholder="Search risks..." class="pl-10 pr-4 py-2 bg-secondary border-secondary rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-ring"></div> <select class="bg-secondary rounded-lg px-3 py-2 w-full md:w-[200px]"><option>All Departments</option><!></select> <select class="bg-secondary rounded-lg px-3 py-2 w-full md:w-[200px]"><option>All Classifications</option><!></select></div> <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto"><div class="flex items-center gap-2"><input type="number" placeholder="Min Budget" class=" px-3 py-2 bg-secondary border-secondary rounded-lg  focus:outline-none focus:ring-2 focus:ring-ring w-[150px]"> <span class="text-muted-foreground">to</span> <input type="number" placeholder="Max Budget" class=" px-3 py-2 bg-secondary border-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-ring w-[150px]"></div> <button class="flex items-center gap-2 bg-secondary px-4 py-2 rounded-lg hover:bg-secondary/80"><!> Export</button> <button class="flex items-center gap-2 bg-primary text-primary-foreground px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors disabled:opacity-50"></button></div></div> <!></div>');function mr(M,r){Ce(r,!0);let l=[],x=!1,_=y(""),b=y(1),m=y(5),k=y(!1),z=y("rrn"),v=y("asc"),A=y("all"),T=y(g([])),K=y(g([])),V=y(g([])),U=y(g([])),L=y(g([])),G=y(g([])),$=y(g([])),Q=y(g([])),re=y(!0),N=y(null),J=y(null),Y=y(null),O=y(null),ie=null,ae=null,W=y("all"),C=g({min:null,max:null});const f=async()=>{const{data:{session:t}}=await h.auth.getSession();if(!t||!t.user)return;const{data:o,error:d}=await h.from("profiles").select("role, first_name, last_name").eq("id",t.user.id).single();if(d){console.error("Error fetching user role:",d);return}s(N,g(o.role)),e(N)==="admin"&&s(J,`${o.first_name} ${o.last_name}`)},c=async()=>{try{const{data:t,error:o}=await h.from("profiles").select("first_name, last_name").eq("role","admin");o||!t?(console.error("Error fetching admin names:",o||"No data found"),s(J,"N/A")):s(J,g(t.map(d=>`${d.first_name} ${d.last_name}`).join(", ")))}catch(t){console.error("Error fetching admin details:",t),s(J,"N/A")}},u=async()=>{try{const{data:t,error:o}=await h.from("profiles").select("first_name, last_name, role").in("role",["vice_president","president"]);if(o||!t){console.error("Error fetching VP and President names:",o||"No data found"),s(Y,"N/A"),s(O,"N/A");return}const d=t.find(p=>p.role==="vice_president"),R=t.find(p=>p.role==="president");s(Y,g(d?`${d.first_name} ${d.last_name}`:"N/A")),s(O,g(R?`${R.first_name} ${R.last_name}`:"N/A"))}catch(t){console.error("Error fetching VP and President details:",t),s(Y,"N/A"),s(O,"N/A")}},I=async()=>{const{data:t,error:o}=await h.from("departments").select("id, name");if(o){console.error("Error fetching departments:",o);return}s(K,g(t||[]))},P=async()=>{const{data:t,error:o}=await h.from("risks").select("*, profiles (first_name, last_name, departments (name))");if(o){console.error("Error fetching risks:",o);return}s(T,g(t.map(d=>{var R,p,X,E;return{...d,user_name:`${((R=d.profiles)==null?void 0:R.first_name)||""} ${((p=d.profiles)==null?void 0:p.last_name)||""}`,department_name:((E=(X=d.profiles)==null?void 0:X.departments)==null?void 0:E.name)||"N/A"}}))),kt()},w=async()=>{const{data:t,error:o}=await h.from("risk_assessment").select("*");if(o){console.error("Error fetching risk assessments:",o);return}s(V,g(t||[]))},F=async()=>{const{data:t,error:o}=await h.from("classification").select("*");o||s(U,g(t||[]))},se=async()=>{const{data:t,error:o}=await h.from("likelihood_rating").select("*");o||s(L,g(t||[]))},ee=async()=>{const{data:t,error:o}=await h.from("severity").select("*");o||s(G,g(t||[]))},_e=async()=>{const{data:t,error:o}=await h.from("risk_control_rating").select("*");o||s($,g(t||[]))},Ve=async()=>{const{data:t,error:o}=await h.from("risk_monitoring_rating").select("*");o||s(Q,g(t||[]))},ke=async t=>{x=!0;let o={};e(N)==="admin"?o={is_approved:!0}:e(N)==="vice_president"?o={is_approved_vp:!0}:e(N)==="president"&&(o={is_approved_president:!0});try{const{data:d,error:R}=await h.from("risks").update(o).eq("id",t).select();if(R){console.error("Error approving risk:",R);return}if(e(N)==="president"&&d&&d.length>0){const p=d[0];if(p.is_approved_president){const{data:X,error:E}=await h.from("risk_monitoring").select("id").eq("risk_id",p.id);if(E){console.error("Error checking existing risk_monitoring entry:",E);return}if(!X||X.length===0){const{data:oe,error:j}=await h.from("risk_assessment").select("*").eq("risk_id",p.id);if(j){console.error("Error fetching risk assessments:",j);return}const te=oe.map(Z=>({risk_id:p.id,likelihood_rating_id:Z.lr,severity_id:Z.s,control_rating_id:Z.rcr,monitoring_rating_id:Z.rmr,department_id:p.department_id})),{error:le}=await h.from("risk_monitoring").insert(te);le&&console.error("Error inserting into risk_monitoring:",le)}}}await P()}catch(d){console.error("Unexpected error while approving risk:",d)}finally{x=!1}},bt=async()=>{x=!0;try{let t={};if(e(N)==="admin")t={is_approved:!0};else if(e(N)==="vice_president")t={is_approved_vp:!0};else if(e(N)==="president")t={is_approved_president:!0};else{console.error("Invalid role for approval."),x=!1;return}const o=l.map(p=>p.id),{data:d,error:R}=await h.from("risks").update(t).in("id",o).select();if(R)throw R;if(e(N)==="president"&&d){for(const p of d)if(p.is_approved_president){const{data:X,error:E}=await h.from("risk_monitoring").select("id").eq("risk_id",p.id);if(E){console.error("Error checking existing risk_monitoring entry:",E);continue}if(!X||X.length===0){const{data:oe,error:j}=await h.from("risk_assessment").select("*").eq("risk_id",p.id);if(j){console.error("Error fetching risk assessments:",j);continue}const te=oe.map(Z=>({risk_id:p.id,likelihood_rating_id:Z.lr,severity_id:Z.s,control_rating_id:Z.rcr,monitoring_rating_id:Z.rmr,department_id:p.department_id})),{error:le}=await h.from("risk_monitoring").insert(te);le&&console.error("Error inserting into risk_monitoring:",le)}}}await P(),console.log("All risks approved successfully.")}catch(t){console.error("Error approving all risks:",t)}finally{x=!1}},yt=async t=>{const{error:o}=await h.from("risks").delete().eq("id",t);o?console.error("Error deleting risk:",o):await P()},kt=()=>{l=e(T)},wt=()=>{var fe;const t=new Ut("landscape"),o="Risk Report",d=["Risk Statement","Classification","Budget","Likelihood","Severity","Control Rating","Monitoring Rating","Approval Status","Department"],R=e(me).flatMap(S=>{var ge;const de=e(V).filter(ne=>ne.risk_id===S.id);return de.length===0?[[S.risk_statement,((ge=e(U).find(ne=>ne.id===S.classification))==null?void 0:ge.name)||"N/A",S.budget||"N/A","N/A","N/A","N/A","N/A",S.is_approved?"Admin Approved":S.is_approved_vp?"VP Approved":S.is_approved_president?"President Approved":"Pending",S.department_name||"N/A"]]:de.map(ne=>{var Re,he,Ae,ve,Te;return[S.risk_statement,((Re=e(U).find(ce=>ce.id===S.classification))==null?void 0:Re.name)||"N/A",S.budget||"N/A",((he=e(L).find(ce=>ce.id===ne.lr))==null?void 0:he.name)||"N/A",((Ae=e(G).find(ce=>ce.id===ne.s))==null?void 0:Ae.value)||"N/A",((ve=e($).find(ce=>ce.id===ne.rcr))==null?void 0:ve.name)||"N/A",((Te=e(Q).find(ce=>ce.id===ne.rmr))==null?void 0:Te.status)||"N/A",S.is_approved?"Admin Approved":S.is_approved_vp?"VP Approved":S.is_approved_president?"President Approved":"Pending",S.department_name||"N/A"]})});t.setFontSize(14),t.text(o,14,15),t.setFontSize(10);let p=[];if(e(_)&&p.push(`Search: "${e(_)}"`),e(A)!=="all"&&p.push(`Department: ${e(A)}`),e(W)!=="all"){const S=(fe=e(U).find(de=>de.id===e(W)))==null?void 0:fe.name;p.push(`Classification: ${S}`)}C.min&&p.push(`Min Budget: ${C.min}`),C.max&&p.push(`Max Budget: ${C.max}`),p.length>0&&t.text(`Filters applied: ${p.join(" | ")}`,14,22),t.setFontSize(14),t.text(o,14,15),jt(t,{head:[d],body:R,startY:25,theme:"grid",styles:{fontSize:10},headStyles:{fillColor:[41,128,185]}});const E=t.internal.pageSize.height-40,oe=t.internal.pageSize.width/4,j=[14,oe,oe*2,oe*3];t.setFontSize(10);const te=l[0],le=(te==null?void 0:te.user_name)||"Unknown",Z=(te==null?void 0:te.department_name)||"Unknown";t.text(`${le||"Unknown"} (sgnd)`,j[0],E-5),t.text("_________________________",j[0],E),t.text(`${Z||"Unknown"} Department Head`,j[0],E+5),t.text(`${e(J)||"N/A"} (sgnd)`,j[1],E-5),t.text("_________________________",j[1],E),t.text("Corporate Planning Officer",j[1],E+5),t.text(`${e(Y)||"N/A"} (sgnd)`,j[2],E-5),t.text("_________________________",j[2],E),t.text("Vice President",j[2],E+5),t.text(`${e(O)||"N/A"} (sgnd)`,j[3],E-5),t.text("_________________________",j[3],E),t.text("President",j[3],E+5);const we=new Date().toLocaleString(),Ze=R.length,qe=e(me).reduce((S,de)=>S+(de.budget||0),0);t.setFontSize(8),t.text(`Exported on: ${we} | Total Records: ${Ze} | Total Budget: P${qe}`,14,t.internal.pageSize.height-10),t.save("Risk_Report.pdf"),t.save("Risk_Report.pdf")},Rt=async()=>{await f(),await c(),await I(),await P(),await w(),await F(),await se(),await ee(),await _e(),await Ve(),await u(),s(re,!1)},At=t=>{e(z)===t?s(v,g(e(v)==="asc"?"desc":"asc")):(s(z,g(t)),s(v,"asc"))},me=Ne(()=>e(T).filter(t=>{const d=`${t.rrn} ${t.risk_statement} ${t.department_name}`.toLowerCase().includes(e(_).toLowerCase()),R=e(A)==="all"||t.department_name===e(A),p=e(W)==="all"||t.classification===e(W),X=(!C.min||t.budget>=C.min)&&(!C.max||t.budget<=C.max);return d&&R&&p&&X}).sort((t,o)=>{const d=String(t[e(z)]),R=String(o[e(z)]);return e(v)==="asc"?d.localeCompare(R):R.localeCompare(d)})),Nt=Ne(()=>e(me).slice((e(b)-1)*e(m),e(b)*e(m))),Et=Ne(()=>Math.ceil(e(me).length/e(m)));Rt();var Le=ur(),Oe=a(Le),rt=a(Oe),Pt=a(rt);xt(Pt,{class:"w-8 h-8 text-primary"}),Pe(2),i(rt),i(Oe);var De=n(Oe,2);De.__click=[nr,k];var St=n(a(De)),Ct=Ne(()=>e(k)?"rotate-180":"");dt(St,{size:16,get class(){return e(Ct)}}),i(De);var Me=n(De,2),He=a(Me),Ke=a(He),it=a(Ke);Bt(it,{class:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground",size:20});var at=n(it,2);Ue(at),i(Ke);var ze=n(Ke,2),Ye=a(ze);Ye.value=(Ye.__value="all")==null?"":"all";var Ft=n(Ye);be(Ft,17,()=>e(K),Se,(t,o)=>{var d=lr(),R={},p=a(d,!0);i(d),q(()=>{R!==(R=e(o).name)&&(d.value=(d.__value=e(o).name)==null?"":e(o).name),B(p,e(o).name)}),D(t,d)}),i(ze);var Qe=n(ze,2),We=a(Qe);We.value=(We.__value="all")==null?"":"all";var Dt=n(We);be(Dt,17,()=>e(U),Se,(t,o)=>{var d=dr(),R={},p=a(d,!0);i(d),q(()=>{R!==(R=e(o).id)&&(d.value=(d.__value=e(o).id)==null?"":e(o).id),B(p,e(o).name)}),D(t,d)}),i(Qe),i(He);var st=n(He,2),Ge=a(st),Je=a(Ge);Ue(Je);var ot=n(Je,4);Ue(ot),i(Ge);var Ie=n(Ge,2);Ie.__click=wt;var Mt=a(Ie);Vt(Mt,{size:20}),Pe(),i(Ie);var Xe=n(Ie,2);Xe.__click=bt,q(()=>Xe.disabled=x||l.every(t=>e(N)==="admin"&&t.is_approved||e(N)==="vice_president"&&t.is_approved_vp||e(N)==="president"&&t.is_approved_president)),Xe.textContent=x?"Processing...":"Approve All Risks",i(st),i(Me);var zt=n(Me,2);pe(zt,()=>e(re),t=>{var o=cr();D(t,o)},t=>{var o=fr(),d=ye(o),R=a(d),p=a(R),X=a(p),E=a(X),oe=a(E);oe.__click=[vr,At];var j=n(a(oe)),te=Ne(()=>e(z)==="rrn"?"text-primary":"");dt(j,{size:16,get class(){return e(te)}}),i(oe),i(E),Pe(7),i(X),i(p);var le=n(p);be(le,21,()=>e(Nt),ve=>ve.id,(ve,Te)=>{or(ve,{get risk(){return e(Te)},get userRole(){return e(N)},get classification(){return e(U)},get likelihoodRatings(){return e(L)},get severities(){return e(G)},get riskControlRatings(){return e($)},get riskMonitoringRatings(){return e(Q)},get riskAssessments(){return e(V)},onDelete:yt,onApprove:ke,get approvingId(){return ie},get deletingId(){return ae}})}),i(le),i(R),i(d);var Z=n(d,2),we=a(Z),Ze=a(we);q(()=>B(Ze,`Showing ${(e(b)-1)*e(m)+1} to ${Math.min(e(b)*e(m),e(me).length)??""} of ${e(me).length??""} results`)),i(we);var qe=n(we,2),fe=a(qe),S=a(fe);S.value=(S.__value=5)==null?"":5;var de=n(S);de.value=(de.__value=10)==null?"":10;var ge=n(de);ge.value=(ge.__value=25)==null?"":25;var ne=n(ge);ne.value=(ne.__value=50)==null?"":50,i(fe);var Re=n(fe,2),he=a(Re);he.__click=[pr,b];var Ae=n(he,2);Ae.__click=[_r,b],i(Re),i(qe),i(Z),q(()=>{he.disabled=e(b)===1,Ae.disabled=e(b)===e(Et)}),je(fe,()=>e(m),ve=>s(m,ve)),D(t,o)}),i(Le),q(()=>gt(Me,`flex flex-col gap-4 ${e(k)?"block":"hidden"} md:flex md:flex-row md:flex-wrap md:justify-between`)),ue(at,()=>e(_),t=>s(_,t)),je(ze,()=>e(A),t=>s(A,t)),je(Qe,()=>e(W),t=>s(W,t)),ue(Je,()=>C.min,t=>C.min=t),ue(ot,()=>C.max,t=>C.max=t),D(M,Le),Fe()}tt(["click"]);var gr=H('<div class="flex items-center justify-center min-h-screen "><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div>'),hr=H('<p class="text-red-500"> </p>'),xr=H("<div><!></div>");function Br(M,r){Ce(r,!1);let l=null,x=$e(null),_=$e(!0),b=$e(null);const m=async()=>{try{const{data:v,error:A}=await h.auth.getSession();if(A)throw A;if(l=v.session,l){const{data:T,error:K}=await h.from("profiles").select("*").eq("id",l.user.id).single();if(K)throw K;s(x,T),console.log("Profile Id: ",e(x).id),console.log("Profile Role: ",e(x).role)}else s(b,"User is not logged in.")}catch(v){console.error(v.message),s(b,"Failed to fetch profile data.")}finally{s(_,!1)}};pt(()=>{m()}),vt();var k=xr(),z=a(k);pe(z,()=>e(_),v=>{var A=gr();D(v,A)},v=>{var A=Be(),T=ye(A);pe(T,()=>e(b),K=>{var V=hr(),U=a(V,!0);i(V),q(()=>B(U,e(b))),D(K,V)},K=>{var V=Be(),U=ye(V);pe(U,()=>{var L,G,$;return((L=e(x))==null?void 0:L.role)==="admin"||((G=e(x))==null?void 0:G.role)==="vice_president"||(($=e(x))==null?void 0:$.role)==="president"},L=>{mr(L,{})},L=>{tr(L,{})}),D(K,V)},!0),D(v,A)}),i(k),D(M,k),Fe()}export{Br as component};
