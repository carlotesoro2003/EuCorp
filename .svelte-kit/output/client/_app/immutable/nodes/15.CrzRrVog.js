import{a as D,t as I}from"../chunks/disclose-version.DTAQul2H.js";import{p as te,c as i,r as s,s as c,g as a,t as X,a as re,b as d,m as A,f as ie,n as se,P as W,Q as Z}from"../chunks/runtime.B4QXH2CN.js";import{d as ae,a as Y,s as ne,b as le}from"../chunks/store.D_on7m4h.js";import{i as R}from"../chunks/if.DRLG6bOh.js";import{a as Q,r as de,e as $,i as ce}from"../chunks/attributes.DPN48yOH.js";import{i as oe}from"../chunks/lifecycle.DAFDPKuL.js";import{p as ue}from"../chunks/stores.BoiHb4t-.js";import{a as C}from"../chunks/Icon.yFnM2WBm.js";import{o as ve}from"../chunks/index-client.Bib29rnf.js";import{b as T}from"../chunks/input.Br29pWBN.js";import{p as K}from"../chunks/preload-helper.B2IhT0O3.js";import{S as pe}from"../chunks/save.DYSOdrWi.js";import{T as _e}from"../chunks/trash-2.DnhmlcTU.js";import{P as me}from"../chunks/plus.BfN9yc11.js";const fe=(p,n,l,F)=>{n()(l()),d(F,!1)};var be=I('<button class="text-green-500 hover:text-green-700 transition-colors p-2"><!></button>'),ge=(p,n)=>n("actions_taken",p.target.value),he=(p,n)=>n("kpi",p.target.value),ye=(p,n)=>n("target_output",p.target.value),xe=(p,n)=>n("budget",+p.target.value),we=(p,n)=>n("key_person_responsible",p.target.value),ke=I('<div class="bg-card rounded-lg p-4 border border-border hover:shadow-lg transition-shadow"><div class="flex justify-between items-start mb-4"><h3 class="text-lg font-semibold"> </h3> <div class="flex gap-2"><!> <button class="text-red-500 hover:text-red-700 transition-colors p-2"><!></button></div></div> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Action Plan</label> <textarea class="w-full h-24 px-3 py-2 bg-card rounded-lg border border-border focus:outline-none focus:ring-2 focus:ring-primary/50"></textarea></div> <div><label class="block text-sm font-medium mb-1">KPI</label> <textarea class="w-full h-24 px-3 py-2 bg-card rounded-lg border border-border focus:outline-none focus:ring-2 focus:ring-primary/50"></textarea></div></div> <div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Target Output</label> <textarea class="w-full h-24 px-3 py-2 bg-card rounded-lg border border-border focus:outline-none focus:ring-2 focus:ring-primary/50"></textarea></div> <div><label class="block text-sm font-medium mb-1">Budget</label> <input type="number" class="w-full px-3 py-2 bg-card rounded-lg border border-border focus:outline-none focus:ring-2 focus:ring-primary/50"></div> <div><label class="block text-sm font-medium mb-1">Key Person Responsible</label> <textarea class="w-full h-24 px-3 py-2 bg-card rounded-lg border border-border focus:outline-none focus:ring-2 focus:ring-primary/50"></textarea></div></div></div></div>');function ee(p,n){te(n,!1);let l=K(n,"data",12),F=K(n,"planNumber",8),b=K(n,"onSave",8,()=>{}),m=K(n,"onEdit",8,()=>{}),u=K(n,"onDelete",8,()=>{}),g=A(!1);const y=(o,_)=>{d(g,!0),m()(o,_)};oe();var w=ke(),v=i(w),E=i(v),G=i(E);s(E);var O=c(E,2),U=i(O);R(U,()=>a(g),o=>{var _=be();_.__click=[fe,b,l,g];var h=i(_);pe(h,{class:"w-5 h-5"}),s(_),D(o,_)});var z=c(U,2);z.__click=[function(...o){var _;(_=u())==null||_.apply(this,o)}];var B=i(z);_e(B,{class:"w-5 h-5"}),s(z),s(O),s(v);var N=c(v,2),j=i(N),S=i(j),q=c(i(S),2);Q(q),q.__input=[ge,y],s(S);var L=c(S,2),t=c(i(L),2);Q(t),t.__input=[he,y],s(L),s(j);var e=c(j,2),r=i(e),f=c(i(r),2);Q(f),f.__input=[ye,y],s(r);var k=c(r,2),P=c(i(k),2);de(P),P.__input=[xe,y],s(k);var x=c(k,2),M=c(i(x),2);Q(M),M.__input=[we,y],s(x),s(e),s(N),s(w),X(()=>Y(G,`Plan ${F()??""}`)),T(q,()=>l().actions_taken,o=>l(l().actions_taken=o,!0)),T(t,()=>l().kpi,o=>l(l().kpi=o,!0)),T(f,()=>l().target_output,o=>l(l().target_output=o,!0)),T(P,()=>l().budget,o=>l(l().budget=o,!0)),T(M,()=>l().key_person_responsible,o=>l(l().key_person_responsible=o,!0)),D(p,w),re()}ae(["click","input"]);var Pe=I('<div class="p-4 rounded-lg bg-green-100 text-green-800"> </div>'),Ee=I('<div class="p-4 rounded-lg bg-red-100 text-red-800"> </div>'),De=I('<div class="flex justify-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div>'),Ie=I('<div class="space-y-4"><!> <!></div> <div class="flex justify-end mt-4 gap-4"><button class="flex items-center gap-2 bg-primary text-primary-foreground px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors"><!> Add New Plan</button></div>',1),Ne=I('<div class="flex flex-col gap-4 p-4 container mx-auto"><!> <!> <div class="bg-card rounded-lg shadow border border-border p-6"><h2 class="text-xl font-semibold mb-4">Action Plans</h2> <!></div></div>');function Qe(p,n){te(n,!1);const l=ne(),F=()=>le(ue,"$page",l);let b=A([]),m=A([]),u=null,g=null,y=A(!1),w=A(null),v=A(null);const E=async()=>{if(!g||!(u!=null&&u.department_id)){d(v,"Objective ID or Department ID is missing."),console.error("Missing IDs: ",{objective_id:g,department_id:u==null?void 0:u.department_id});return}d(y,!0);try{const{data:t,error:e}=await C.from("action_plans").select("*").eq("objective_id",g).eq("department_id",u.department_id).order("id",{ascending:!0});if(e)throw e;d(b,t||[])}catch(t){console.error("Error fetching action plans:",t),d(v,"Failed to fetch action plans.")}finally{d(y,!1)}},G=()=>{if(!(u!=null&&u.id)||!u.department_id||!g){d(v,"Missing required profile or objective information.");return}d(m,[...a(m),{actions_taken:"",kpi:"",target_output:"",key_person_responsible:"",objective_id:g,profile_id:u.id,department_id:u.department_id,budget:0,isNew:!0}])},O=(t,e,r,f)=>{f?W(m,a(m)[t]={...a(m)[t],[e]:r}):W(b,a(b)[t]={...a(b)[t],[e]:r,isEdited:!0})},U=async t=>{try{const{error:e}=await C.from("action_plans").delete().eq("id",t);if(e)throw e;await E(),d(w,"Plan deleted successfully!")}catch(e){console.error("Error deleting plan:",e),d(v,"Failed to delete plan.")}},z=t=>{d(m,a(m).filter((e,r)=>r!==t))},B=async(t,e)=>{try{let r;e?r=a(m)[t]:r=a(b)[t];const{isEdited:f,isNew:k,...P}=r,{error:x}=await C.from("action_plans").upsert(P,{onConflict:"id"});if(x)throw x;e?(d(m,a(m).filter((M,o)=>o!==t)),await E()):W(b,a(b)[t].isEdited=!1),d(w,"Plan saved successfully!")}catch(r){console.error("Error saving plan:",r),d(v,"Failed to save plan.")}};ve(async()=>{var t;try{const{params:e}=F();if(g=parseInt(e.id),!g){d(v,"Objective ID is missing."),console.error("Objective ID is null or invalid:",e.id);return}const r=await C.auth.getUser();if(!((t=r==null?void 0:r.data)!=null&&t.user)){d(v,"User not logged in.");return}const{data:f,error:k}=await C.from("profiles").select("id, department_id").eq("id",r.data.user.id).single();if(k||!f){d(v,"Failed to fetch user profile details.");return}u=f,await E()}catch(e){console.error("Error during initialization:",e),d(v,"Initialization failed.")}}),oe();var N=Ne(),j=i(N);R(j,()=>a(w),t=>{var e=Pe(),r=i(e,!0);s(e),X(()=>Y(r,a(w))),D(t,e)});var S=c(j,2);R(S,()=>a(v),t=>{var e=Ee(),r=i(e,!0);s(e),X(()=>Y(r,a(v))),D(t,e)});var q=c(S,2),L=c(i(q),2);R(L,()=>a(y),t=>{var e=De();D(t,e)},t=>{var e=Ie(),r=ie(e),f=i(r);$(f,3,()=>a(b),o=>o.id,(o,_,h)=>{var H=Z(()=>a(h)+1);ee(o,{get data(){return a(_)},get planNumber(){return a(H)},onEdit:(J,V)=>O(a(h),J,V,!1),onSave:()=>B(a(h),!1),onDelete:()=>U(a(_).id)})});var k=c(f,2);$(k,1,()=>a(m),ce,(o,_,h)=>{var H=Z(()=>a(b).length+h+1);ee(o,{get data(){return a(_)},get planNumber(){return a(H)},onEdit:(J,V)=>O(h,J,V,!0),onSave:()=>B(h,!0),onDelete:()=>z(h)})}),s(r);var P=c(r,2),x=i(P);x.__click=G;var M=i(x);me(M,{class:"w-4 h-4 mr-2"}),se(),s(x),s(P),D(t,e)}),s(q),s(N),D(p,N),re()}ae(["click"]);export{Qe as component};
